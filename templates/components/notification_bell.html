{% load static %}

<!-- Notification Bell Dropdown -->
<div class="relative" x-data="{ open: false, unreadCount: {{ unread_count|default:0 }} }">
    <!-- Bell Icon Button -->
    <button 
        @click="open = !open; if(open) loadNotifications()"
        class="relative flex items-center justify-center w-10 h-10 rounded-lg bg-white/5 hover:bg-white/10 text-gray-300 hover:text-white transition-colors"
        aria-label="Notifications"
    >
        <span class="material-symbols-outlined">notifications</span>
        
        <!-- Unread Badge -->
        <span 
            x-show="unreadCount > 0" 
            x-text="unreadCount > 99 ? '99+' : unreadCount"
            class="absolute -top-1 -right-1 flex items-center justify-center min-w-[20px] h-5 px-1 text-xs font-bold text-white bg-red-600 rounded-full"
        ></span>
    </button>
    
    <!-- Dropdown Panel -->
    <div 
        x-show="open" 
        @click.away="open = false"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95"
        class="absolute right-0 mt-2 w-96 max-w-[calc(100vw-2rem)] bg-gray-800 border border-gray-700 rounded-xl shadow-2xl z-50 overflow-hidden"
        style="display: none;"
    >
        <!-- Header -->
        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-700">
            <h3 class="text-lg font-bold text-white">Notifications</h3>
            <button 
                @click="markAllAsRead()"
                class="text-sm text-gray-400 hover:text-white transition"
            >
                Mark all read
            </button>
        </div>
        
        <!-- Notifications List -->
        <div id="notifications-list" class="max-h-96 overflow-y-auto">
            <!-- Loading State -->
            <div id="notifications-loading" class="flex items-center justify-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"></div>
            </div>
            
            <!-- Notifications will be loaded here -->
            <div id="notifications-content" class="hidden"></div>
            
            <!-- Empty State -->
            <div id="notifications-empty" class="hidden flex flex-col items-center justify-center py-12 px-4">
                <span class="material-symbols-outlined text-gray-600 text-5xl mb-3">notifications_off</span>
                <p class="text-gray-400 text-sm">No notifications yet</p>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="px-4 py-3 border-t border-gray-700 bg-gray-800/50">
            <a 
                href="{% url 'notifications:list' %}" 
                class="block text-center text-sm font-medium text-red-600 hover:text-red-500 transition"
            >
                View all notifications
            </a>
        </div>
    </div>
</div>

<script>
// Notification Bell Functions
function loadNotifications() {
    const loading = document.getElementById('notifications-loading');
    const content = document.getElementById('notifications-content');
    const empty = document.getElementById('notifications-empty');
    
    loading.classList.remove('hidden');
    content.classList.add('hidden');
    empty.classList.add('hidden');
    
    fetch('{% url "notifications:recent" %}', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        loading.classList.add('hidden');
        
        if (data.notifications.length === 0) {
            empty.classList.remove('hidden');
            return;
        }
        
        content.classList.remove('hidden');
        content.innerHTML = data.notifications.map(notif => `
            <a 
                href="${notif.action_url || '/notifications/' + notif.id + '/'}"
                class="block px-4 py-3 hover:bg-white/5 transition border-b border-gray-700/50 ${notif.read ? '' : 'bg-red-600/5'}"
                onclick="markAsRead('${notif.id}')"
            >
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 mt-1">
                        ${getNotificationIcon(notif.type, notif.priority)}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-start justify-between gap-2">
                            <p class="text-sm font-medium text-white truncate">${notif.title}</p>
                            ${!notif.read ? '<div class="flex-shrink-0 w-2 h-2 bg-red-600 rounded-full"></div>' : ''}
                        </div>
                        <p class="text-sm text-gray-400 line-clamp-2 mt-1">${notif.message}</p>
                        <p class="text-xs text-gray-500 mt-1">${formatTime(notif.created_at)}</p>
                    </div>
                </div>
            </a>
        `).join('');
    })
    .catch(error => {
        console.error('Error loading notifications:', error);
        loading.classList.add('hidden');
        content.innerHTML = '<div class="px-4 py-8 text-center text-gray-400">Failed to load notifications</div>';
        content.classList.remove('hidden');
    });
}

function getNotificationIcon(type, priority) {
    const icons = {
        'tournament': 'emoji_events',
        'coaching': 'school',
        'team': 'group',
        'payment': 'payment',
        'system': 'info',
        'security': 'security',
        'venue': 'place',
        'match': 'sports_esports',
        'message': 'mail',
        'achievement': 'military_tech'
    };
    
    const colors = {
        'urgent': 'text-red-500',
        'high': 'text-orange-500',
        'normal': 'text-blue-500',
        'low': 'text-gray-500'
    };
    
    const icon = icons[type] || 'notifications';
    const color = colors[priority] || 'text-gray-400';
    
    return `<span class="material-symbols-outlined ${color}">${icon}</span>`;
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diff = Math.floor((now - date) / 1000); // seconds
    
    if (diff < 60) return 'Just now';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
    
    return date.toLocaleDateString();
}

function markAsRead(notificationId) {
    fetch(`/notifications/${notificationId}/read/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateUnreadCount();
        }
    })
    .catch(error => console.error('Error marking notification as read:', error));
}

function markAllAsRead() {
    fetch('{% url "notifications:mark_all_as_read" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateUnreadCount();
            loadNotifications();
        }
    })
    .catch(error => console.error('Error marking all as read:', error));
}

function updateUnreadCount() {
    fetch('{% url "notifications:unread_count" %}')
        .then(response => response.json())
        .then(data => {
            // Update Alpine.js data
            const bellComponent = document.querySelector('[x-data]');
            if (bellComponent && bellComponent.__x) {
                bellComponent.__x.$data.unreadCount = data.count;
            }
        })
        .catch(error => console.error('Error updating unread count:', error));
}

// Poll for new notifications every 30 seconds
setInterval(updateUnreadCount, 30000);
</script>
