{% extends "layouts/dashboard_base.html" %}
{% load static responsive_images %}

{% block title %}Edit Profile - EYTGaming{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<style>
    .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    
    /* Upload area styling */
    .upload-area {
        border: 2px dashed #374151;
        transition: all 0.3s ease;
    }
    
    .upload-area:hover {
        border-color: #b91c1c;
        background-color: rgba(185, 28, 28, 0.05);
    }
    
    .upload-area.dragover {
        border-color: #b91c1c;
        background-color: rgba(185, 28, 28, 0.1);
    }
    
    /* Form styling improvements */
    .form-input {
        width: 100%;
        border-radius: 0.5rem;
        border: 1px solid #4b5563;
        background-color: #1f2937;
        color: #ffffff !important;
        padding: 0.75rem;
        font-size: 0.875rem;
        transition: all 0.3s ease;
    }
    
    .form-input::placeholder {
        color: #9ca3af;
    }
    
    .form-input:focus {
        outline: none;
        border-color: #b91c1c;
        box-shadow: 0 0 0 2px rgba(185, 28, 28, 0.5);
    }
    
    .form-input:hover {
        border-color: #6b7280;
    }
    
    /* Ensure all form inputs have visible text */
    input[type="text"], 
    input[type="email"], 
    input[type="tel"], 
    input[type="date"], 
    textarea, 
    select {
        color: #ffffff !important;
        background-color: #1f2937 !important;
    }
    
    /* Fix for Django form widgets */
    .form-input input,
    .form-input textarea,
    .form-input select {
        color: #ffffff !important;
        background-color: #1f2937 !important;
    }
    
    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #d1d5db;
        margin-bottom: 0.5rem;
    }
    
    /* Character counter */
    .char-counter {
        @apply text-xs text-gray-400 mt-1;
    }
    
    .char-counter.over-limit {
        @apply text-red-400;
    }
    
    /* Progress bar animation */
    .progress-bar {
        transition: width 0.5s ease-in-out;
    }
</style>
{% endblock %}

{% block content %}
<main class="flex-1 p-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 flex flex-col gap-8">
            <!-- Page Header -->
            <div>
                <h1 class="text-gray-900 dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]">Edit Profile</h1>
            </div>

            <!-- Messages -->
            {% if messages %}
                <div class="space-y-3">
                    {% for message in messages %}
                        <div class="p-4 rounded-xl border {% if message.tags == 'success' %}bg-green-900/20 border-green-500/30 text-green-300{% elif message.tags == 'error' %}bg-red-900/20 border-red-500/30 text-red-300{% elif message.tags == 'warning' %}bg-yellow-900/20 border-yellow-500/30 text-yellow-300{% else %}bg-blue-900/20 border-blue-500/30 text-blue-300{% endif %}">
                            <div class="flex items-center gap-3">
                                <span class="material-symbols-outlined">
                                    {% if message.tags == 'success' %}check_circle{% elif message.tags == 'error' %}error{% elif message.tags == 'warning' %}warning{% else %}info{% endif %}
                                </span>
                                <p>{{ message }}</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Profile Completeness Widget -->
            {% if completeness %}
                <div class="bg-white dark:bg-[#111318] p-6 rounded-xl border border-gray-200 dark:border-gray-800">
                    <div class="flex flex-col gap-3">
                        <div class="flex gap-6 justify-between items-center">
                            <p class="text-gray-900 dark:text-white text-base font-medium leading-normal">Profile Completeness</p>
                            <p class="text-primary text-sm font-bold leading-normal">{{ completeness.percentage }}%</p>
                        </div>
                        <div class="w-full rounded-full bg-gray-200 dark:bg-[#3b4354]">
                            <div class="h-2 rounded-full bg-primary progress-bar" style="width: {{ completeness.percentage }}%;"></div>
                        </div>
                        {% if completeness.percentage < 100 %}
                            <p class="text-gray-500 dark:text-[#9da6b9] text-sm font-normal leading-normal">Add your gaming accounts to complete your profile!</p>
                        {% else %}
                            <p class="text-green-500 dark:text-green-400 text-sm font-normal leading-normal">Your profile is 100% complete! Great job!</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <!-- Profile Images Section -->
            <div class="flex flex-col gap-y-6">
                <h2 class="text-gray-900 dark:text-white text-[22px] font-bold leading-tight tracking-[-0.015em]">Profile Images</h2>
                <div class="flex flex-col gap-4">
                    <!-- Banner Upload -->
                    <div class="flex flex-col items-center gap-6 rounded-xl border-2 border-dashed border-gray-300 dark:border-[#3b4354] px-6 py-14 upload-area" id="banner-upload-area">
                        {% if user.banner %}
                            <div class="w-full max-w-md h-32 rounded-lg overflow-hidden">
                                {% responsive_banner user.banner "Current Banner" "w-full h-full object-cover" "banner-preview" %}
                            </div>
                        {% endif %}
                        <div class="flex max-w-[480px] flex-col items-center gap-2 text-center">
                            <p class="text-gray-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Profile Banner</p>
                            <p class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal">1920x400px, Max 5MB</p>
                        </div>
                        <form method="post" enctype="multipart/form-data" id="banner-form">
                            {% csrf_token %}
                            <input type="file" name="banner" id="banner-input" accept="image/*" class="hidden" onchange="previewBanner(event)" aria-label="Upload banner image">
                            <button type="button" onclick="document.getElementById('banner-input').click()" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-gray-200 dark:bg-[#282e39] text-gray-900 dark:text-white text-sm font-bold leading-normal tracking-[0.015em]">
                                <span>Upload Banner</span>
                            </button>
                        </form>
                    </div>
                    
                    <!-- Avatar Upload -->
                    <div class="flex flex-col items-center gap-6 rounded-xl border-2 border-dashed border-gray-300 dark:border-[#3b4354] px-6 py-14 upload-area" id="avatar-upload-area">
                        {% if user.avatar %}
                            <div class="w-24 h-24 rounded-full overflow-hidden">
                                {% responsive_avatar user.avatar "Current Avatar" "w-full h-full object-cover" True "avatar-preview" %}
                            </div>
                        {% else %}
                            <div class="w-24 h-24 rounded-full bg-primary flex items-center justify-center">
                                <span class="text-white text-2xl font-bold">{{ user.get_display_name|first|upper }}</span>
                            </div>
                        {% endif %}
                        <div class="flex max-w-[480px] flex-col items-center gap-2 text-center">
                            <p class="text-gray-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Profile Avatar</p>
                            <p class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal">400x400px, Max 2MB</p>
                        </div>
                        <form method="post" enctype="multipart/form-data" id="avatar-form">
                            {% csrf_token %}
                            <input type="file" name="avatar" id="avatar-input" accept="image/*" class="hidden" onchange="previewAvatar(event)" aria-label="Upload avatar image">
                            <button type="button" onclick="document.getElementById('avatar-input').click()" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-gray-200 dark:bg-[#282e39] text-gray-900 dark:text-white text-sm font-bold leading-normal tracking-[0.015em]">
                                <span>Upload Avatar</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Basic Information Section -->
            <div class="flex flex-col gap-y-6">
                <h2 class="text-gray-900 dark:text-white text-[22px] font-bold leading-tight tracking-[-0.015em]">Basic Information</h2>
                <form method="post" id="profile-form">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-6">
                        <!-- Display Name -->
                        <div class="flex flex-col gap-y-2">
                            <label class="form-label" for="id_display_name">Display Name</label>
                            {{ profile_form.display_name }}
                            {% if profile_form.display_name.errors %}
                                <p class="text-sm text-red-400">{{ profile_form.display_name.errors.0 }}</p>
                            {% endif %}
                        </div>
                        
                        <!-- First Name -->
                        <div class="flex flex-col gap-y-2">
                            <label class="form-label" for="id_first_name">First Name</label>
                            {{ profile_form.first_name }}
                        </div>
                        
                        <!-- Last Name -->
                        <div class="flex flex-col gap-y-2">
                            <label class="form-label" for="id_last_name">Last Name</label>
                            {{ profile_form.last_name }}
                        </div>
                        
                        <!-- Date of Birth -->
                        <div class="flex flex-col gap-y-2">
                            <label class="form-label" for="id_date_of_birth">Date of Birth</label>
                            {{ profile_form.date_of_birth }}
                        </div>
                        
                        <!-- Country -->
                        <div class="flex flex-col gap-y-2">
                            <label class="form-label" for="id_country">Country</label>
                            {{ profile_form.country }}
                        </div>
                        
                        <!-- City -->
                        <div class="flex flex-col gap-y-2">
                            <label class="form-label" for="id_city">City</label>
                            {{ profile_form.city }}
                        </div>
                        
                        <!-- Phone Number -->
                        <div class="flex flex-col gap-y-2 md:col-span-2">
                            <label class="form-label" for="id_phone_number">Phone Number</label>
                            {{ profile_form.phone_number }}
                        </div>
                        
                        <!-- Bio -->
                        <div class="flex flex-col gap-y-2 md:col-span-2">
                            <div class="flex justify-between">
                                <label class="form-label" for="id_bio">Bio</label>
                                <span class="text-xs text-gray-500 dark:text-gray-400" id="bio-counter">0 / 500</span>
                            </div>
                            {{ profile_form.bio }}
                            {% if profile_form.bio.errors %}
                                <p class="text-sm text-red-400">{{ profile_form.bio.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="flex justify-end gap-4 mt-6">
                        <a href="{% url 'dashboard:profile_view' user.username %}" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-gray-200 dark:bg-[#282e39] text-gray-800 dark:text-white text-sm font-bold leading-normal tracking-[0.015em]" aria-label="Cancel profile editing and return to profile">Cancel</a>
                        <button type="submit" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em]">Save Changes</button>
                    </div>
                </form>
            </div>

            <!-- Gaming Accounts Section -->
            <div class="flex flex-col gap-y-6">
                <h2 class="text-gray-900 dark:text-white text-[22px] font-bold leading-tight tracking-[-0.015em]">Gaming Accounts</h2>
                <form method="post" id="gaming-accounts-form">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Discord -->
                        <div>
                            <label class="form-label" for="id_discord_username">Discord Username</label>
                            {{ profile_form.discord_username }}
                        </div>
                        
                        <!-- Steam -->
                        <div>
                            <label class="form-label" for="id_steam_id">Steam ID</label>
                            {{ profile_form.steam_id }}
                        </div>
                        
                        <!-- Twitch -->
                        <div class="md:col-span-2">
                            <label class="form-label" for="id_twitch_username">Twitch Username</label>
                            {{ profile_form.twitch_username }}
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-sm font-bold leading-normal tracking-[0.015em]" aria-label="Cancel gaming account changes">Cancel</button>
                        <button type="submit" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em]">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="hidden lg:block space-y-8">
            <!-- Quick Links -->
            <div class="bg-white dark:bg-[#111318] p-6 rounded-xl border border-gray-200 dark:border-gray-800">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Quick Links</h3>
                <ul class="space-y-3">
                    <li><a class="flex items-center gap-2 text-primary hover:underline" href="{% url 'dashboard:profile_view' user.username %}"><span class="material-symbols-outlined text-base">visibility</span>View Profile</a></li>
                    <li><a class="flex items-center gap-2 text-primary hover:underline" href="{% url 'dashboard:settings_privacy' %}"><span class="material-symbols-outlined text-base">privacy_tip</span>Privacy Settings</a></li>
                    <li><a class="flex items-center gap-2 text-primary hover:underline" href="{% url 'dashboard:settings_security' %}"><span class="material-symbols-outlined text-base">security</span>Security Settings</a></li>
                    <li><a class="flex items-center gap-2 text-primary hover:underline" href="{% url 'dashboard:game_profile_list' %}"><span class="material-symbols-outlined text-base">sports_esports</span>Manage Game Profiles</a></li>
                </ul>
            </div>
            
            <!-- Profile Tips -->
            <div class="bg-white dark:bg-[#111318] p-6 rounded-xl border border-gray-200 dark:border-gray-800">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Profile Tips</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">A complete profile with a banner and avatar is more likely to receive team invites and followers.</p>
            </div>
            
            <!-- Account Stats -->
            <div class="bg-white dark:bg-[#111318] p-6 rounded-xl border border-gray-200 dark:border-gray-800">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Account Stats</h3>
                <ul class="space-y-3 text-sm">
                    <li class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Member Since:</span>
                        <span class="font-medium text-gray-900 dark:text-white">{{ user.date_joined|date:"M Y" }}</span>
                    </li>
                    <li class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Profile Views:</span>
                        <span class="font-medium text-gray-900 dark:text-white">-</span>
                    </li>
                    <li class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Last Updated:</span>
                        <span class="font-medium text-gray-900 dark:text-white">{{ user.updated_at|date:"M d, Y"|default:"Today" }}</span>
                    </li>
                </ul>
            </div>
        </aside>
    </div>
</main>

<script>
    // Banner preview function
    function previewBanner(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                let preview = document.getElementById('banner-preview');
                if (preview) {
                    preview.src = e.target.result;
                } else {
                    // Create new preview image
                    const uploadArea = document.getElementById('banner-upload-area');
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'w-full max-w-md h-32 rounded-lg overflow-hidden';
                    imageContainer.innerHTML = `<img src="${e.target.result}" alt="Banner Preview" id="banner-preview" class="w-full h-full object-cover">`;
                    uploadArea.insertBefore(imageContainer, uploadArea.children[0]);
                }
            };
            reader.readAsDataURL(file);
            
            // Auto-submit form after preview
            setTimeout(() => {
                document.getElementById('banner-form').submit();
            }, 500);
        }
    }

    // Avatar preview function
    function previewAvatar(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                let preview = document.getElementById('avatar-preview');
                if (preview) {
                    preview.src = e.target.result;
                } else {
                    // Create new preview image
                    const uploadArea = document.getElementById('avatar-upload-area');
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'w-24 h-24 rounded-full overflow-hidden';
                    imageContainer.innerHTML = `<img src="${e.target.result}" alt="Avatar Preview" id="avatar-preview" class="w-full h-full object-cover">`;
                    uploadArea.insertBefore(imageContainer, uploadArea.children[0]);
                }
            };
            reader.readAsDataURL(file);
            
            // Auto-submit form after preview
            setTimeout(() => {
                document.getElementById('avatar-form').submit();
            }, 500);
        }
    }

    // Drag and drop functionality
    function setupDragAndDrop() {
        const uploadAreas = document.querySelectorAll('.upload-area');
        
        uploadAreas.forEach(area => {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                area.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                area.addEventListener(eventName, () => area.classList.add('dragover'), false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                area.addEventListener(eventName, () => area.classList.remove('dragover'), false);
            });
            
            area.addEventListener('drop', handleDrop, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                const file = files[0];
                const area = e.currentTarget;
                
                if (area.id === 'banner-upload-area') {
                    document.getElementById('banner-input').files = files;
                    previewBanner({ target: { files: [file] } });
                } else if (area.id === 'avatar-upload-area') {
                    document.getElementById('avatar-input').files = files;
                    previewAvatar({ target: { files: [file] } });
                }
            }
        }
    }

    // Character counter for bio
    function setupBioCounter() {
        const bioField = document.querySelector('textarea[name="bio"]');
        const counter = document.getElementById('bio-counter');
        
        if (bioField && counter) {
            const maxLength = 500;
            
            function updateCounter() {
                const currentLength = bioField.value.length;
                counter.textContent = `${currentLength} / ${maxLength}`;
                
                if (currentLength > maxLength) {
                    counter.classList.add('over-limit');
                } else {
                    counter.classList.remove('over-limit');
                }
            }
            
            // Initial count
            updateCounter();
            
            // Update on input
            bioField.addEventListener('input', updateCounter);
        }
    }

    // Style form fields
    function styleFormFields() {
        // Style all text inputs
        const textInputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="date"]');
        textInputs.forEach(input => {
            input.className = 'form-input';
            // Ensure text is visible
            input.style.color = '#ffffff';
            input.style.backgroundColor = '#1f2937';
            input.style.border = '1px solid #4b5563';
        });

        // Style textareas
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            textarea.className = 'form-input';
            textarea.rows = 4;
            textarea.placeholder = textarea.placeholder || 'Tell us about yourself...';
            // Ensure text is visible
            textarea.style.color = '#ffffff';
            textarea.style.backgroundColor = '#1f2937';
            textarea.style.border = '1px solid #4b5563';
        });

        // Style selects
        const selects = document.querySelectorAll('select');
        selects.forEach(select => {
            select.className = 'form-input';
            // Ensure text is visible
            select.style.color = '#ffffff';
            select.style.backgroundColor = '#1f2937';
            select.style.border = '1px solid #4b5563';
        });
    }

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        styleFormFields();
        setupBioCounter();
        setupDragAndDrop();
    });
</script>
{% endblock %}
