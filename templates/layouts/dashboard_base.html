{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<style>
    /* Screen reader only content */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
    }
    
    /* Mobile menu animation */
    #mobile-menu {
        transition: opacity 0.3s ease-in-out;
    }
    
    #mobile-menu:not(.hidden) {
        animation: fadeIn 0.3s ease-in-out;
    }
    
    #mobile-menu > div {
        transition: transform 0.3s ease-in-out;
        transform: translateX(-100%);
    }
    
    #mobile-menu:not(.hidden) > div {
        transform: translateX(0);
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
    
    /* Ensure mobile menu is above everything */
    #mobile-menu {
        z-index: 9999;
    }
    
    /* Better touch targets for mobile */
    @media (max-width: 768px) {
        #mobile-menu a {
            min-height: 44px;
            display: flex;
            align-items: center;
        }
    }
</style>
{% endblock %}

{% block body %}
<!-- Skip to main content link for keyboard navigation -->
<a href="#main-content" class="skip-to-main">Skip to main content</a>

<div class="flex min-h-screen">
    <!-- Sidebar Navigation -->
    <aside class="w-64 flex-shrink-0 bg-background-light dark:bg-background-dark border-r border-card-border-dark hidden md:flex flex-col">
        <div class="flex flex-col h-full p-4">
            <!-- Logo -->
            <div class="flex items-center gap-3 p-2 mb-6">
                <img src="{% static 'images/EYTLOGO.jpg' %}" alt="EYTGaming Logo" class="h-10 w-auto"/>
                <h1 class="text-white text-xl font-bold">EYTGaming</h1>
            </div>
            
            <!-- Main Navigation -->
            <nav class="flex flex-col gap-2" role="navigation" aria-label="Main navigation">
                <a href="{% url 'dashboard:home' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg {% if request.resolver_match.url_name == 'home' %}bg-primary/20 text-primary{% else %}text-gray-300 hover:bg-card-dark transition-colors{% endif %}" aria-label="Dashboard{% if request.resolver_match.url_name == 'home' %}, current page{% endif %}" {% if request.resolver_match.url_name == 'home' %}aria-current="page"{% endif %}>
                    <span class="material-symbols-outlined" aria-hidden="true">dashboard</span>
                    <p class="text-sm font-medium">Dashboard</p>
                </a>
                
                <a href="{% url 'tournaments:list' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg {% if 'tournaments' in request.path %}bg-primary/20 text-primary{% else %}text-gray-300 hover:bg-card-dark transition-colors{% endif %}" aria-label="Tournaments{% if 'tournaments' in request.path %}, current page{% endif %}" {% if 'tournaments' in request.path %}aria-current="page"{% endif %}>
                    <span class="material-symbols-outlined" aria-hidden="true">emoji_events</span>
                    <p class="text-sm font-medium">Tournaments</p>
                </a>
                
                <a href="{% url 'coaching:coach_list' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg {% if 'coaching' in request.path %}bg-primary/20 text-primary{% else %}text-gray-300 hover:bg-card-dark transition-colors{% endif %}" aria-label="Coaching{% if 'coaching' in request.path %}, current page{% endif %}" {% if 'coaching' in request.path %}aria-current="page"{% endif %}>
                    <span class="material-symbols-outlined" aria-hidden="true">sports_esports</span>
                    <p class="text-sm font-medium">Coaching</p>
                </a>
                
                <a href="{% url 'teams:list' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg {% if 'teams' in request.path %}bg-primary/20 text-primary{% else %}text-gray-300 hover:bg-card-dark transition-colors{% endif %}" aria-label="Teams{% if 'teams' in request.path %}, current page{% endif %}" {% if 'teams' in request.path %}aria-current="page"{% endif %}>
                    <span class="material-symbols-outlined" aria-hidden="true">groups</span>
                    <p class="text-sm font-medium">Teams</p>
                </a>
                
                <a href="{% url 'venues:list' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg {% if 'venues' in request.path %}bg-primary/20 text-primary{% else %}text-gray-300 hover:bg-card-dark transition-colors{% endif %}" aria-label="Venues{% if 'venues' in request.path %}, current page{% endif %}" {% if 'venues' in request.path %}aria-current="page"{% endif %}>
                    <span class="material-symbols-outlined" aria-hidden="true">location_on</span>
                    <p class="text-sm font-medium">Venues</p>
                </a>
                
                <a href="{% url 'dashboard:profile_view' username=request.user.username %}" class="flex items-center gap-3 px-3 py-2 rounded-lg {% if 'profile' in request.path %}bg-primary/20 text-primary{% else %}text-gray-300 hover:bg-card-dark transition-colors{% endif %}" aria-label="Profile{% if 'profile' in request.path %}, current page{% endif %}" {% if 'profile' in request.path %}aria-current="page"{% endif %}>
                    <span class="material-symbols-outlined" aria-hidden="true">person</span>
                    <p class="text-sm font-medium">Profile</p>
                </a>
            </nav>
            
            <!-- Bottom Navigation -->
            <div class="mt-auto flex flex-col gap-2">
                <a href="{% url 'payments:payment_methods' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-card-dark transition-colors" aria-label="Payment methods">
                    <span class="material-symbols-outlined" aria-hidden="true">payment</span>
                    <p class="text-sm font-medium">Payments</p>
                </a>
                
                <a href="{% url 'notifications:preferences' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-card-dark transition-colors" aria-label="Settings">
                    <span class="material-symbols-outlined" aria-hidden="true">settings</span>
                    <p class="text-sm font-medium">Settings</p>
                </a>
                
                <a href="{% url 'account_logout' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-card-dark transition-colors" aria-label="Logout">
                    <span class="material-symbols-outlined" aria-hidden="true">logout</span>
                    <p class="text-sm font-medium">Logout</p>
                </a>
            </div>
        </div>
    </aside>
    
    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col">
        <!-- Top Navigation Bar -->
        <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-card-border-dark px-6 py-3 h-16 flex-shrink-0">
            <!-- Mobile Menu Button -->
            <button class="md:hidden text-gray-300" onclick="toggleMobileMenu()" aria-label="Open navigation menu" aria-expanded="false" aria-controls="mobile-menu">
                <span class="material-symbols-outlined" aria-hidden="true">menu</span>
            </button>
            
            <!-- Search Bar -->
            <div class="flex flex-1 items-center gap-8">
                <label class="hidden md:flex flex-col min-w-40 !h-10 max-w-64">
                    <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
                        <div class="text-gray-400 flex border-none bg-card-dark items-center justify-center pl-3 rounded-l-lg border-r-0">
                            <span class="material-symbols-outlined">search</span>
                        </div>
                        <input 
                            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-0 border-none bg-card-dark focus:border-none h-full placeholder:text-gray-400 px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal" 
                            placeholder="Search tournaments, coaches..." 
                            type="search"
                            aria-label="Search tournaments, coaches, and other content"
                        />
                    </div>
                </label>
            </div>
            
            <!-- Right Side Icons -->
            <div class="flex items-center gap-4">
                <!-- Notification Bell -->
                <div class="relative">
                    <button onclick="toggleNotifications()" class="relative text-gray-300 hover:text-white transition-colors" aria-label="Notifications" aria-expanded="false" aria-controls="notification-dropdown">
                        <span class="material-symbols-outlined" aria-hidden="true">notifications</span>
                        <span id="notification-badge" class="absolute -top-1 -right-1 bg-primary text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold" aria-label="0 unread notifications">
                            0
                        </span>
                    </button>
                    
                    <!-- Notification Dropdown -->
                    <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-card-dark border border-card-border-dark rounded-lg shadow-xl z-50">
                        <div class="p-4 border-b border-card-border-dark">
                            <h3 class="text-white font-semibold">Notifications</h3>
                        </div>
                        <div id="notification-list" class="max-h-96 overflow-y-auto">
                            <!-- Notifications loaded via AJAX -->
                        </div>
                        <div class="p-3 border-t border-card-border-dark text-center">
                            <a href="{% url 'notifications:list' %}" class="text-primary hover:text-primary-light text-sm font-medium">View All</a>
                        </div>
                    </div>
                </div>
                
                <!-- User Profile Dropdown -->
                <div class="relative">
                    <button onclick="toggleUserMenu()" class="flex items-center gap-2 text-gray-300 hover:text-white transition-colors" aria-label="User menu for {{ user.get_display_name }}" aria-expanded="false" aria-controls="user-dropdown">
                        {% if user.avatar %}
                            <img src="{{ user.avatar.url }}" alt="{{ user.get_display_name }}" class="h-8 w-8 rounded-full object-cover"/>
                        {% else %}
                            <div class="h-8 w-8 rounded-full bg-primary flex items-center justify-center text-white font-bold">
                                {{ user.get_display_name|first|upper }}
                            </div>
                        {% endif %}
                        <span class="hidden sm:inline text-sm font-medium">{{ user.get_display_name }}</span>
                        <span class="material-symbols-outlined text-sm" aria-hidden="true">expand_more</span>
                    </button>
                    
                    <!-- User Dropdown Menu -->
                    <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-card-dark border border-card-border-dark rounded-lg shadow-xl z-50" role="menu" aria-label="User menu">
                        <a href="{% url 'dashboard:profile_view' username=request.user.username %}" class="block px-4 py-2 text-gray-300 hover:bg-neutral-800 transition-colors" role="menuitem" aria-label="View profile">
                            <span class="material-symbols-outlined text-sm mr-2" aria-hidden="true">person</span>
                            Profile
                        </a>
                        <a href="{% url 'payments:history' %}" class="block px-4 py-2 text-gray-300 hover:bg-neutral-800 transition-colors" role="menuitem" aria-label="View payment history">
                            <span class="material-symbols-outlined text-sm mr-2" aria-hidden="true">receipt</span>
                            Payments
                        </a>
                        <a href="{% url 'notifications:preferences' %}" class="block px-4 py-2 text-gray-300 hover:bg-neutral-800 transition-colors" role="menuitem" aria-label="Settings">
                            <span class="material-symbols-outlined text-sm mr-2" aria-hidden="true">settings</span>
                            Settings
                        </a>
                        <hr class="border-card-border-dark my-1"/>
                        <a href="{% url 'account_logout' %}" class="block px-4 py-2 text-red-400 hover:bg-neutral-800 transition-colors" role="menuitem" aria-label="Logout">
                            <span class="material-symbols-outlined text-sm mr-2" aria-hidden="true">logout</span>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Page Content -->
        <div id="main-content" class="flex-1 overflow-y-auto p-6" role="main">
            <!-- Django Messages -->
            {% if messages %}
                <div class="mb-4 space-y-2" role="alert" aria-live="{% if message.tags == 'error' %}assertive{% else %}polite{% endif %}">
                    {% for message in messages %}
                        <div class="flex items-center gap-3 px-4 py-3 rounded-lg {% if message.tags == 'error' %}bg-red-900/20 border border-red-800 text-red-200{% elif message.tags == 'success' %}bg-green-900/20 border border-green-800 text-green-200{% elif message.tags == 'warning' %}bg-yellow-900/20 border border-yellow-800 text-yellow-200{% else %}bg-blue-900/20 border border-blue-800 text-blue-200{% endif %}" role="alert">
                            <span class="material-symbols-outlined" aria-hidden="true">
                                {% if message.tags == 'error' %}error{% elif message.tags == 'success' %}check_circle{% elif message.tags == 'warning' %}warning{% else %}info{% endif %}
                            </span>
                            <p>{{ message }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            
            {% block content %}{% endblock %}
        </div>
    </main>
</div>

<!-- Mobile Menu Overlay -->
<div id="mobile-menu" class="hidden fixed inset-0 bg-black/50 z-50 md:hidden" onclick="toggleMobileMenu()">
    <div class="w-64 h-full bg-background-dark border-r border-card-border-dark" onclick="event.stopPropagation()">
        <div class="flex flex-col h-full p-4">
            <!-- Logo and Close Button -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <img src="{% static 'images/EYTLOGO.jpg' %}" alt="EYTGaming Logo" class="h-10 w-auto"/>
                    <h1 class="text-white text-xl font-bold">EYTGaming</h1>
                </div>
                <button onclick="toggleMobileMenu()" class="text-gray-300 hover:text-white" aria-label="Close navigation menu">
                    <span class="material-symbols-outlined" aria-hidden="true">close</span>
                </button>
            </div>
            
            <!-- Main Navigation -->
            <nav class="flex flex-col gap-2" role="navigation" aria-label="Mobile navigation">
                <a href="{% url 'dashboard:home' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg {% if request.resolver_match.url_name == 'home' %}bg-primary/20 text-primary{% else %}text-gray-300 hover:bg-card-dark transition-colors{% endif %}" aria-label="Dashboard{% if request.resolver_match.url_name == 'home' %}, current page{% endif %}" {% if request.resolver_match.url_name == 'home' %}aria-current="page"{% endif %}>
                    <span class="material-symbols-outlined" aria-hidden="true">dashboard</span>
                    <p class="text-sm font-medium">Dashboard</p>
                </a>
                
                <a href="{% url 'tournaments:list' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg {% if 'tournaments' in request.path %}bg-primary/20 text-primary{% else %}text-gray-300 hover:bg-card-dark transition-colors{% endif %}" aria-label="Tournaments{% if 'tournaments' in request.path %}, current page{% endif %}" {% if 'tournaments' in request.path %}aria-current="page"{% endif %}>
                    <span class="material-symbols-outlined" aria-hidden="true">emoji_events</span>
                    <p class="text-sm font-medium">Tournaments</p>
                </a>
                
                <a href="{% url 'coaching:coach_list' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg {% if 'coaching' in request.path %}bg-primary/20 text-primary{% else %}text-gray-300 hover:bg-card-dark transition-colors{% endif %}" aria-label="Coaching{% if 'coaching' in request.path %}, current page{% endif %}" {% if 'coaching' in request.path %}aria-current="page"{% endif %}>
                    <span class="material-symbols-outlined" aria-hidden="true">sports_esports</span>
                    <p class="text-sm font-medium">Coaching</p>
                </a>
                
                <a href="{% url 'teams:list' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg {% if 'teams' in request.path %}bg-primary/20 text-primary{% else %}text-gray-300 hover:bg-card-dark transition-colors{% endif %}" aria-label="Teams{% if 'teams' in request.path %}, current page{% endif %}" {% if 'teams' in request.path %}aria-current="page"{% endif %}>
                    <span class="material-symbols-outlined" aria-hidden="true">groups</span>
                    <p class="text-sm font-medium">Teams</p>
                </a>
                
                <a href="{% url 'venues:list' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg {% if 'venues' in request.path %}bg-primary/20 text-primary{% else %}text-gray-300 hover:bg-card-dark transition-colors{% endif %}" aria-label="Venues{% if 'venues' in request.path %}, current page{% endif %}" {% if 'venues' in request.path %}aria-current="page"{% endif %}>
                    <span class="material-symbols-outlined" aria-hidden="true">location_on</span>
                    <p class="text-sm font-medium">Venues</p>
                </a>
                
                <a href="{% url 'dashboard:profile_view' username=request.user.username %}" class="flex items-center gap-3 px-3 py-2 rounded-lg {% if 'profile' in request.path %}bg-primary/20 text-primary{% else %}text-gray-300 hover:bg-card-dark transition-colors{% endif %}" aria-label="Profile{% if 'profile' in request.path %}, current page{% endif %}" {% if 'profile' in request.path %}aria-current="page"{% endif %}>
                    <span class="material-symbols-outlined" aria-hidden="true">person</span>
                    <p class="text-sm font-medium">Profile</p>
                </a>
            </nav>
            
            <!-- Bottom Navigation -->
            <div class="mt-auto flex flex-col gap-2">
                <a href="{% url 'payments:payment_methods' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-card-dark transition-colors" aria-label="Payment methods">
                    <span class="material-symbols-outlined" aria-hidden="true">payment</span>
                    <p class="text-sm font-medium">Payments</p>
                </a>
                
                <a href="{% url 'notifications:preferences' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-card-dark transition-colors" aria-label="Settings">
                    <span class="material-symbols-outlined" aria-hidden="true">settings</span>
                    <p class="text-sm font-medium">Settings</p>
                </a>
                
                <a href="{% url 'account_logout' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-card-dark transition-colors" aria-label="Logout">
                    <span class="material-symbols-outlined" aria-hidden="true">logout</span>
                    <p class="text-sm font-medium">Logout</p>
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // Toggle mobile menu
    function toggleMobileMenu() {
        const mobileMenu = document.getElementById('mobile-menu');
        const menuButton = document.querySelector('[aria-controls="mobile-menu"]');
        const isHidden = mobileMenu.classList.contains('hidden');
        
        mobileMenu.classList.toggle('hidden');
        
        // Update ARIA attributes
        if (menuButton) {
            menuButton.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
            menuButton.setAttribute('aria-label', isHidden ? 'Close navigation menu' : 'Open navigation menu');
        }
        
        // Prevent body scroll when menu is open
        if (!mobileMenu.classList.contains('hidden')) {
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = '';
        }
    }
    
    // Close mobile menu when clicking on a link
    document.addEventListener('DOMContentLoaded', function() {
        const mobileMenuLinks = document.querySelectorAll('#mobile-menu a');
        mobileMenuLinks.forEach(link => {
            link.addEventListener('click', function() {
                toggleMobileMenu();
            });
        });
    });
    
    // Toggle notifications dropdown
    function toggleNotifications() {
        const dropdown = document.getElementById('notification-dropdown');
        const button = document.querySelector('[aria-controls="notification-dropdown"]');
        const isHidden = dropdown.classList.contains('hidden');
        
        dropdown.classList.toggle('hidden');
        
        // Update ARIA attributes
        if (button) {
            button.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
        }
        
        loadNotifications();
    }
    
    // Toggle user menu dropdown
    function toggleUserMenu() {
        const dropdown = document.getElementById('user-dropdown');
        const button = document.querySelector('[aria-controls="user-dropdown"]');
        const isHidden = dropdown.classList.contains('hidden');
        
        dropdown.classList.toggle('hidden');
        
        // Update ARIA attributes
        if (button) {
            button.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
        }
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        const notifDropdown = document.getElementById('notification-dropdown');
        const userDropdown = document.getElementById('user-dropdown');
        
        if (!event.target.closest('.relative')) {
            notifDropdown.classList.add('hidden');
            userDropdown.classList.add('hidden');
        }
    });
    
    // Load notifications via AJAX
    async function loadNotifications() {
        try {
            const response = await fetch('/notifications/recent/', {
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            });
            const data = await response.json();
            
            // Update badge
            document.getElementById('notification-badge').textContent = data.unread_count;
            
            // Render notifications
            const list = document.getElementById('notification-list');
            if (data.notifications.length === 0) {
                list.innerHTML = '<p class="p-4 text-center text-gray-400">No notifications</p>';
            } else {
                list.innerHTML = data.notifications.map(n => `
                    <a href="/notifications/${n.id}/" class="block px-4 py-3 hover:bg-neutral-800 transition-colors border-b border-card-border-dark ${n.read ? '' : 'bg-primary/5'}">
                        <div class="flex items-start gap-3">
                            <span class="material-symbols-outlined text-primary mt-1">
                                ${n.type === 'tournament' ? 'emoji_events' : n.type === 'coaching' ? 'sports_esports' : n.type === 'payment' ? 'payment' : 'notifications'}
                            </span>
                            <div class="flex-1 min-w-0">
                                <p class="text-white font-medium text-sm">${n.title}</p>
                                <p class="text-gray-400 text-xs mt-1 truncate">${n.message}</p>
                                <p class="text-gray-500 text-xs mt-1">${new Date(n.created_at).toLocaleString()}</p>
                            </div>
                        </div>
                    </a>
                `).join('');
            }
        } catch (error) {
            console.error('Failed to load notifications:', error);
        }
    }
    
    // Poll for new notifications every 30 seconds
    setInterval(async () => {
        try {
            const response = await fetch('/notifications/unread-count/');
            const data = await response.json();
            document.getElementById('notification-badge').textContent = data.count;
        } catch (error) {
            console.error('Failed to update notification count:', error);
        }
    }, 30000);
    
    // Load initial notification count
    loadNotifications();
</script>
{% endblock %}

