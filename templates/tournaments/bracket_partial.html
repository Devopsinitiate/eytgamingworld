{% load static %}
{% load custom_filters %}

{# Partial template for HTMX bracket updates #}
{% for bracket in brackets %}
<div class="mb-12" id="bracket-{{ bracket.id }}">
    {# Bracket Header #}
    <div class="round-header rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold text-white flex items-center">
                    <span class="material-symbols-outlined text-primary mr-3">emoji_events</span>
                    {{ bracket.name }}
                </h2>
                <p class="text-gray-300 mt-1">{{ bracket.total_rounds }} rounds ‚Ä¢ {{ bracket.matches.count }} matches
                </p>
            </div>

            {# Live Updates Indicator #}
            <div class="flex items-center space-x-4">
                <div class="live-indicator flex items-center space-x-2">
                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                    <span class="text-sm text-green-400 font-medium">Live Updates</span>
                </div>

                {# Bracket Stats #}
                <div class="text-right">
                    <div class="text-sm text-gray-400">Matches Completed</div>
                    <div class="text-lg font-bold text-white">
                        {{ bracket.completed_matches }}/{{ bracket.total_matches }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Bracket Container with Horizontal Scroll #}
    <div class="bg-gray-800/30 backdrop-blur-lg rounded-xl border border-white/10 overflow-hidden">
        <div class="overflow-x-auto">
            <div class="bracket-content p-8 min-w-max">
                <div class="flex space-x-12 relative">
                    {% for round_num, matches in matches_by_bracket|get_item:bracket.id|dict_items %}
                    {# Round Column #}
                    <div class="flex flex-col space-y-6 min-w-[280px] relative">
                        {# Round Header #}
                        <div class="text-center mb-6">
                            <div class="round-header rounded-lg p-3 mx-4">
                                <h3 class="text-lg font-bold text-white">
                                    {% if round_num == bracket.total_rounds %}
                                    üèÜ Grand Finals
                                    {% elif round_num == bracket.total_rounds|add:"-1" %}
                                    ü•à Semi-Finals
                                    {% elif round_num == bracket.total_rounds|add:"-2" %}
                                    ü•â Quarter-Finals
                                    {% else %}
                                    Round {{ round_num }}
                                    {% endif %}
                                </h3>
                                <p class="text-sm text-gray-300 mt-1">{{ matches|length }} match{{
                                    matches|length|pluralize:"es" }}</p>
                            </div>
                        </div>

                        {# Matches in Round #}
                        {% for match in matches %}
                        <div class="match-card rounded-xl p-6 relative {% if match.status == 'completed' %}match-updated{% endif %}"
                            data-match-id="{{ match.id }}" data-status="{{ match.status }}">
                            {# Match Header #}
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs font-medium text-gray-400">Match {{ match.match_number
                                        }}</span>
                                    {% if match.scheduled_time %}
                                    <div class="match-time text-gray-300">
                                        {{ match.scheduled_time|date:"M d, g:i A" }}
                                    </div>
                                    {% endif %}
                                </div>

                                {# Match Status Badge #}
                                <div
                                    class="match-status-badge {% if match.status == 'completed' %}status-completed{% elif match.status == 'in_progress' %}status-live{% elif match.status == 'ready' %}status-ready{% elif match.status == 'disputed' %}status-disputed{% else %}status-pending{% endif %}">
                                    {% if match.status == 'completed' %}
                                    <span class="material-symbols-outlined text-xs mr-1">check_circle</span>
                                    Completed
                                    {% elif match.status == 'in_progress' %}
                                    <span
                                        class="material-symbols-outlined text-xs mr-1 live-indicator">radio_button_checked</span>
                                    Live
                                    {% elif match.status == 'ready' %}
                                    <span class="material-symbols-outlined text-xs mr-1">play_circle</span>
                                    Ready
                                    {% elif match.status == 'disputed' %}
                                    <span class="material-symbols-outlined text-xs mr-1">warning</span>
                                    Disputed
                                    {% else %}
                                    <span class="material-symbols-outlined text-xs mr-1">schedule</span>
                                    Pending
                                    {% endif %}
                                </div>
                            </div>

                            {# Participant 1 #}
                            <div
                                class="participant-slot rounded-lg p-4 mb-2 {% if match.winner == match.participant1 %}winner{% elif match.status == 'completed' %}loser{% endif %}">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3 flex-1 min-w-0">
                                        {% if match.participant1 %}
                                        <div class="participant-avatar">
                                            {{ match.participant1.display_name|first|upper }}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-semibold text-white truncate">
                                                {{ match.participant1.display_name }}
                                            </div>
                                            {% if match.participant1.team %}
                                            <div class="text-xs text-gray-400 truncate">
                                                {{ match.participant1.team.name }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% if match.winner == match.participant1 %}
                                        <span class="material-symbols-outlined text-green-400">emoji_events</span>
                                        {% endif %}
                                        {% else %}
                                        <div class="participant-avatar bg-gray-600">
                                            <span class="material-symbols-outlined text-xs">person</span>
                                        </div>
                                        <span class="text-gray-400 italic flex-1">To Be Determined</span>
                                        {% endif %}
                                    </div>
                                    {% if match.status == 'completed' %}
                                    <div
                                        class="score-display {% if match.winner == match.participant1 %}text-green-400{% else %}text-gray-500{% endif %}">
                                        {{ match.score_p1|default:"-" }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            {# VS Divider #}
                            <div class="text-center py-2">
                                <div class="inline-flex items-center space-x-2 text-xs font-bold text-gray-400">
                                    <div class="w-8 h-px bg-gray-600"></div>
                                    <span>VS</span>
                                    <div class="w-8 h-px bg-gray-600"></div>
                                </div>
                            </div>

                            {# Participant 2 #}
                            <div
                                class="participant-slot rounded-lg p-4 mb-4 {% if match.winner == match.participant2 %}winner{% elif match.status == 'completed' %}loser{% endif %}">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3 flex-1 min-w-0">
                                        {% if match.participant2 %}
                                        <div class="participant-avatar">
                                            {{ match.participant2.display_name|first|upper }}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-semibold text-white truncate">
                                                {{ match.participant2.display_name }}
                                            </div>
                                            {% if match.participant2.team %}
                                            <div class="text-xs text-gray-400 truncate">
                                                {{ match.participant2.team.name }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% if match.winner == match.participant2 %}
                                        <span class="material-symbols-outlined text-green-400">emoji_events</span>
                                        {% endif %}
                                        {% else %}
                                        <div class="participant-avatar bg-gray-600">
                                            <span class="material-symbols-outlined text-xs">person</span>
                                        </div>
                                        <span class="text-gray-400 italic flex-1">To Be Determined</span>
                                        {% endif %}
                                    </div>
                                    {% if match.status == 'completed' %}
                                    <div
                                        class="score-display {% if match.winner == match.participant2 %}text-green-400{% else %}text-gray-500{% endif %}">
                                        {{ match.score_p2|default:"-" }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            {% if user.is_authenticated and match.is_ready and match.status != 'completed' %}
                            {% if user == tournament.organizer or user.role == 'admin' or match.participant1.user ==
                            user or match.participant2.user == user %}
                            <div class="pt-4 border-t border-gray-700">
                                <a href="{% url 'tournaments:match_report' match.pk %}"
                                    class="w-full inline-flex items-center justify-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition font-medium text-sm">
                                    <span class="material-symbols-outlined text-sm mr-2">edit_note</span>
                                    Report Score
                                </a>
                            </div>
                            {% endif %}
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% empty %}
<div class="flex flex-col items-center justify-center p-12 text-center">
    <div class="bg-gray-800/50 rounded-full p-6 mb-4">
        <span class="material-symbols-outlined text-4xl text-gray-500">schema</span>
    </div>
    <h3 class="text-xl font-bold text-white mb-2">No Bracket Generated</h3>
    <p class="text-gray-400 max-w-md">
        The tournament bracket has not been generated yet.
        It will be available once the tournament starts.
    </p>
</div>
{% endfor %}